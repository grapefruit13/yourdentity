name: Firebase Functions ìë™ ë°°í¬

on:
  push:
    branches:
      - "main"
    paths:
      - "be/functions/**"
      - ".github/workflows/firebase-deploy.yml"

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Functions Deploy Job
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: "be/functions/pnpm-lock.yaml"

      - name: Firebase CLI ì„¤ì¹˜
        run: npm install -g firebase-tools@12.9.1

      - name: Firebase ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: ë°°í¬ìš© .env ìƒì„±
        working-directory: be/functions
        shell: bash
        env:
          ENV_VARS: ${{ secrets.ENV_VARS }}
        run: |
          set -euo pipefail
          
          echo "ğŸ“ ë°°í¬ìš© .env ìƒì„± ì‹œì‘"
          
          # íŒŒì¼ ê¶Œí•œ ì œí•œ (ë³´ì•ˆ)
          umask 077
          
          # ê¸°ì¡´ .env íŒŒì¼ ì œê±° í›„ ìƒˆë¡œ ìƒì„±
          rm -f .env
          touch .env
          chmod 600 .env
          
          # ê¸°ë³¸ í™˜ê²½ ì„¤ì •
          echo "NODE_ENV=production" > .env
          
          # GitHub Secretì˜ í™˜ê²½ë³€ìˆ˜ë¥¼ .envì— ì£¼ì…
          # ì£¼ì„(#ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì¤„)ê³¼ ë¹ˆ ì¤„ì€ ì œì™¸
          if [ -n "${ENV_VARS:-}" ]; then
            echo "$ENV_VARS" | grep -v '^\s*#' | grep -v '^\s*$' >> .env
          else
            echo "âŒ ì˜¤ë¥˜: ENV_VARS Secretì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤" >&2
            exit 1
          fi
          
          # .env íŒŒì¼ ìƒì„± ì™„ë£Œ í™•ì¸
          line_count=$(wc -l < .env | tr -d ' ')
          if [ "$line_count" -lt 2 ]; then
            echo "âŒ ì˜¤ë¥˜: .env íŒŒì¼ì´ ì œëŒ€ë¡œ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" >&2
            exit 1
          fi
          
          echo "âœ… .env ìƒì„± ì™„ë£Œ (${line_count}ì¤„)"

      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
        working-directory: be/functions
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
          pnpm install --frozen-lockfile
          
          echo "ğŸ”¨ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘"
          pnpm run build
          
          echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: Firebase Functions ë°°í¬
        working-directory: be/functions
        id: deploy
        run: |
          echo "ğŸš€ Firebase Functions ë°°í¬ ì‹œì‘"
          firebase deploy --only functions
          echo "deploy-success=true" >> $GITHUB_OUTPUT

      - name: ë°°í¬ ì„±ê³µ ë¡œê·¸
        if: success()
        run: |
          echo " ================================"
          echo " Firebase Functions ë°°í¬ ì„±ê³µ!"
          echo " ================================"
          echo " Commit: ${GITHUB_SHA:0:7}"
          echo " Branch: ${GITHUB_REF#refs/heads/}"
          echo " ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo " Repository: ${{ github.repository }}"

      - name: ë°°í¬ ì‹¤íŒ¨ ë¡œê·¸
        if: failure()
        run: |
          echo " ================================"
          echo " Firebase Functions ë°°í¬ ì‹¤íŒ¨"
          echo " ================================"
          echo " Commit: ${GITHUB_SHA:0:7}"
          echo " Branch: ${GITHUB_REF#refs/heads/}"
          echo " ì‹¤íŒ¨ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo " ì›Œí¬í”Œë¡œìš° ë¡œê·¸:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
